{% extends "layout.html" %}
{% block title %}Flask MVC App{% endblock %}
{% block page %}Flask MVC App{% endblock %}

{{ super() }}

{% block content %}
    <div id="map" style="height: 100vh; width: 100%; position: fixed; top: 0; left: 0;"></div>
    <input type="button" id="modeButton" value="Change Mode" class="waves-effect waves-light btn" style="position: fixed; bottom: 10px; left: 10px; z-index: 1000;" onclick="changeMode()">
    <div id="pane" class="card col s4" style="position: fixed; top: 50%; left: -300px; transform: translateY(-50%); z-index: 1000; width: 300px; background: white; overflow:auto; transition: left 0.3s ease; height:100%">
    </div>
    <button id="recenterButton" class="waves-effect btn" style="position: fixed; bottom: 74px; right: 10px; z-index: 1000; background: white; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; padding: 0;" onclick="recenterMap()">
        <img src="https://www.freeiconspng.com/uploads/maps-center-direction-icon-24.png" alt="Recenter" style="width: 25px; height: 25px;">
    </button>
    

    
{% endblock %}

{% block code %}
    <script type="text/javascript">
        var map = L.map('map').setView([10.642529, -61.400225], 13); // Sets the initial map position and zoom level
        var layerTest = L.layerGroup();
        var overlayMaps = {  // Filter categories
            "Test" : layerTest 
        };
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            }
        });
        var layerControl = L.control.layers(null, overlayMaps, { position: 'bottomright' }).addTo(map);
        var marker = L.marker([10.6464474, -61.4008066]).addTo(map);
        var mode = 'view';
        var currentMarker;
        
        map.addControl(drawControl);
        marker.on('click', onMarkerClick);
        map.on('load', addObjects()); // Call the addMarkers() function when the map loads
        map.on('click', onMapClick);
        map.on(L.Draw.Event.CREATED, function(e){
            var layer = e.layer;
            currentMarker = layer;
            var type = e.layerType;
            console.log(layer.latlng)
            drawnItems.addLayer(layer);

            if(type === 'marker'){
                let pane = document.querySelector('#pane');
                if (pane.innerHTML.trim() === '') {
                    //Form for adding markers
                    let html = `
    <div class="row" id="addMarkerForm">
        <div class="col s12">
        <button style="float: right; background: none; border: none; font-size: 1.5em; cursor: pointer;" onclick="cancelAdd()">Ã—</button>
            <form action="/addMarker" method="POST" enctype="multipart/form-data" style='padding:2em;'>
                <div class="row">
                    <div class="input-field col s12">
                        <label for="markerName" style="position:static;">Name</label>
                        <input placeholder="eg. FST 114" id="markerName" name="markerName" type="text" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="floorNum" style="position:static;">Floor #</label>
                        <input placeholder="eg. 0" id="floorNum" name="floorNum" type="number" step="1" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="buildingName" style="position:static;">Building Name</label>
                        <select name="buildingChoice" id="buildingChoice" style="display:static;" required>
                            <option value="" disabled selected>Choose a building</option>
                    `;
                    //Populates the select with all the buildings
                    {% for building in buildingObjects %}
                        html += `
                            <option value="{{building.buildingID}}">{{building.name}}</option>
                        `
                    {% endfor %}

                    html += `
                    </select>
                    </div>
                    <div class="input-field col s12">
                        <label for="description" style="position:static;">Description (Optional)</label>
                        <textarea class="materialize-textarea" placeholder="eg. Located on right of south entrance" name="description" id="description" rows="4" cols="12"></textarea>
                    </div>

                    <div class="input-field col s12">
                            <label for="imageUpload" style="position:static">Upload Image (Optional)</label>
                    </div>
                    <div class="file-field input-field col s12">
                        <div class="btn-small blue">
                            <span><i class="material-icons">file_upload</i></span>
                            <input type="file" name="imageUpload" id="imageUpload" accept="image/*">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text">
                        </div>
                    </div>
                    
                    <input type="hidden" name="x" id="x" value="${layer.getLatLng().lat}">
                    <input type="hidden" name="y" id="y" value="${layer.getLatLng().lng}">
                    <div class="input-field col s12">
                      <button class="waves-effect waves-light btn" type="submit">Add Marker</button>
                      <input class="waves-effect waves-light white btn black-text" type="button" value="Cancel" onclick="cancelAdd()">   
                    </div>
                </div>
            </form>
        </div>
    </div>`;
                pane.innerHTML = html;
                pane.style.left = '10px';

                //Materialize select fields need these 2 lines to of code to actually initialize the options for some reson
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);
                }
            }

            if(type === 'polygon' || type === 'circle' || type === 'rectangle'){
                var geoJSON = layer.toGeoJSON()
                console.log(geoJSON)
                let data = {building: "test", data: geoJSON}
                    fetch("/addDrawing", {
                        method: "POST",
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    }).then(res => {
                        console.log(`Added drawing with coords ${data} to database`);
                    });
            }
        });

        // Move zoom controls under the layer control toggle
        map.zoomControl.setPosition('bottomright');
        document.querySelector('.leaflet-control-zoom').style.marginBottom = '47px';
        document.querySelectorAll('.leaflet-control-zoom a').forEach(button => {
            button.style.width = '45px';
            button.style.height = '35px';
        });

        // GeoJSON example
        var paneTest = {
            "type": "FeatureCollection",
            "features": [
                {
                "type": "Feature",
                "properties": {
                    "name": "Test Pane",
                    "amenity": "Polygon",
                    "popupContent": "Test popup for polygon"
                },
                "geometry": {
                    "coordinates": [
                    [
                        [
                        -61.39998930812794,
                        10.638831871955404
                        ],
                        [
                        -61.39953237900065,
                        10.638589128766455
                        ],
                        [
                        -61.39937801105165,
                        10.638661951743003
                        ],
                        [
                        -61.399538553718685,
                        10.63901999779469
                        ],
                        [
                        -61.39998930812794,
                        10.638831871955404
                        ]
                    ]
                    ],
                    "type": "Polygon"
                }
                }
            ]
        };

        L.geoJSON(paneTest, {
            onEachFeature: onEachFeature
        }).addTo(map);

        //Just closes the pane and removes the marker that was initially put down when adding a marker
        function cancelAdd(){
            map.removeLayer(currentMarker);
            closeContainer();
        }

        //What happens on the backend is for each marker object, its attributes are appended to a list, and then that list is sent
        //here, where each element of the list(i.e. attribute of the marker) is added to the marker objected created here. 
        //I could have just passed the markers from the backend using jinja, I can't remember why I had to resort to this, but it's kinda late to change
        //it right now. May neaten up if we have time.
        function addObjects(){
            var markers = {{markers|safe}} //Grab markers from backend
            for(marker of markers){
                var newMarker = L.marker([marker[0], marker[1]]).addTo(map); // Adds each marker to the map
                console.log("markerid: " + marker[2])
                newMarker.id = marker[2];
                newMarker.name = marker[3];
                newMarker.floor = marker[4];
                newMarker.description = marker[5];
                newMarker.building = marker[6];
                newMarker.image = marker[7];
                newMarker.on('click', onMarkerClick);
                layerTest.addLayer(marker); // Add each marker to the layerGroup
            }

            var buildings = {{buildings|safe}}
            for(building of buildings){
                var name = building[0];
                var drawingCoords = JSON.parse(building[1]);
                //drawnItems.addLayer(drawingCoords)
                
                drawingCoords.properties["name"] = name;
                console.log(drawingCoords);
                L.geoJSON(drawingCoords).addTo(map);
            }
        }

        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.popupContent) {
                layer.bindPopup(feature.properties.popupContent);
            }
        }
        
        function onMarkerClick(e){
            console.log(e.target.id);
            marker = e.target
            currentMarker = marker;
            //fetch(`/viewMarker/${e.target.id}`)
            let pane = document.querySelector('#pane');
            //Brings up the edit marker form. The form sends a POST request to editMarker, however you can't actually submit this form by default.
            //By default the form actually just displays the marker info.
            //There is an edit button at the bottom which, if clicked, replaces the contents of the form with editable fields, and a button which
            //actually submits the form. Very jank way of doing this.
            //The delete button is also here, but since a form can't send both a POST and a GET request to 2 differnet routes, the delete button just
            //calls a JS function thats sends a GET request to the deleteMarker route.
            let html = `
    <div class="row">
        <div class="col s12">
        
            <form method="POST" action="/editMarker/${marker.id}">
            <div>`
            //Only add the image if one exists for the current marker
            if(marker.image != ''){
                html += `
                <div class="card-image">
                    <img src="${marker.image}" height="300" style="object-fit:cover; object-position: 20% 10%;">
                    <button style="float: right; background: none; border: none; font-size: 1.5em; cursor: pointer; z-index:1500;" onclick="closeContainer()">Ã—</button>
                </div>
                `
            } else {
                html += `<button style="float: right; background: none; border: none; font-size: 1.5em; cursor: pointer; z-index:1500;" onclick="closeContainer()">Ã—</button>`
            }
            html += `
                <div name="markerInfoForm" id="markerInfoForm" class="card-content">
                    <span class="card-title"><h5>Marker Information</h5></span>
                    <h6>Name</h6>
                    <p>${marker.name}</p>
                    <h6>Building</h6>
                    <p>${marker.building}</p>
                    <h6>Floor #</h6>
                    <p>${marker.floor}</p>
                    <h6>Description</h6>
                    <p>${marker.description}</p>
                </div>
                <div name="markerInfoFormButtons" id="markerInfoFormButtons" class="card-action">
                    <input type="button" onclick="editMarkerView()" class="waves-effect waves-light orange btn" value="Edit">
                    <button type="button" onclick="deleteMarker(${marker.id})" class="waves-effect waves-light red btn right">Delete</button>
                </div>
            </div>
            </form>
        </div>
    </div>
            `;
            pane.innerHTML = html;
            pane.style.left = '10px';
        }
        
        //"Manually" sends a GET request to /deleteMarker
        function deleteMarker(id){
            fetch(`/deleteMarker/${id}`).then(res => {
                console.log(`Deleted marker from database`);
                window.location.reload()
            });
        }

        //If the edit button is clicked, then this function is what actually "makes" all the fields in the form editable and adds the real submit button
        function editMarkerView(){
            let infoPane = document.querySelector('#markerInfoForm');
            if(infoPane != null){
                html = `
                    <div class="input-field col s12">
                        <label for="markerName" style="position:static;">Name</label>
                        <input value="${currentMarker.name}" id="markerName" name="markerName" type="text" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="floorNum" style="position:static;">Floor #</label>
                        <input value="${currentMarker.floor}" id="floorNum" name="floorNum" type="number" step="1" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="buildingName" style="position:static;">Building Name</label>
                        <select name="buildingChoice" id="buildingChoice" style="display:static;">
                            <option value="" selected disabled>${currentMarker.building}</option>
                    `;
                    {% for building in buildingObjects %}
                        if("{{building.name}}" != currentMarker.building){
                            html += `
                               <option value="{{building.buildingID}}">{{building.name}}</option>
                            `
                        }
                    {% endfor %}
                    html += `
                    </select>
                    </div>
                    <div class="input-field col s12">
                        <label for="description" style="position:static;">Description (Optional)</label>
                        <textarea class="materialize-textarea" name="description" id="description" rows="4" cols="12">${currentMarker.description}</textarea>
                    </div>
                    <p>Current coordinates</p>
                    <span style="white-space:nowrap">
                        <label for="x">X:  </label>
                        <input type="text" name="x" id="x" value="${currentMarker.getLatLng().lat}">
                    </span>
                    <span style="white-space:nowrap">
                        <label for="y">Y:  </label>
                        <input type="text" name="y" id="y" value="${currentMarker.getLatLng().lng}">
                    </span>
                    <button type="button" class="waves-effect waves-light blue btn" onclick="coordUpdateMode()">Move</button>
                    <sub style="color: grey;">(Click new location on map)</sub>
                `;
                infoPane.innerHTML = html;
                //Have to initialize select options once again
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);

                //This code replaces the button with the real button to actually submit the form
                var buttons = document.querySelector('#markerInfoFormButtons');
                if(buttons != null){
                    console.log('y');
                    buttons.innerHTML = `
                      <button class="waves-effect waves-light orange btn" type="submit">Update Marker</button>
                      <input class="waves-effect waves-light white btn black-text" type="button" value="Cancel" onclick="closeContainer()">    
                    `;
                } else {
                    console.log("n")
                }
            }
        }

        //Self explanatory
        function closeContainer(){
            let pane = document.querySelector('#pane');
            pane.innerHTML = '';
            pane.style.left = '-300px';
        }

        //If you are editing a form, and want to change the coordinates of the marker, then this function gets called and sets the mode to update, which
        //well let the onMapClick function return the coords of where you click instead of doing anything else.
        function coordUpdateMode(){
            mode = 'update';
        }

        //This function can use some cleaning up and separating. As it is right now, it's actually been replaced by another one. To be removed and properly
        //segregated.
        function onMapClick(e){
            if(mode === 'edit'){
                //marker = L.marker(e.latlng).addTo(map).on('click', onMarkerClick);
                /*alert("Added marker at " + e.latlng.toString());
                let data = {x: e.latlng.lat, y: e.latlng.lng};
                fetch("/addMarker", {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                }).then(res => {
                    console.log(`Added ${e.latlng} to database`);
                });*/
                
                //Form to add a marker
                let pane = document.querySelector('#pane');
                if (pane.innerHTML.trim() === '') {
                    let html = `
                    <div class="row" id="addMarkerForm">
        <div class="col s12">
            <form action="/addMarker" method="POST" style='padding:2em;'>
                <div class="row">
                    <div class="input-field col s12">
                        <label for="markerName" style="position:static;">Name</label>
                        <input placeholder="eg. FST 114" id="markerName" name="markerName" type="text" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="floorNum" style="position:static;">Floor #</label>
                        <input placeholder="eg. 0" id="floorNum" name="floorNum" type="number" step="1" class="validate" required>
                    </div>
                    <div class="input-field col s12">
                        <label for="buildingName" style="position:static;">Building Name</label>
                        <select name="buildingChoice" id="buildingChoice" style="display:static;">
                            <option value="" disabled selected>Choose a building</option>
                    `;
                    {% for building in buildingObjects %}
                        html += `
                            <option value="{{building.buildingID}}">{{building.name}}</option>
                        `
                    {% endfor %}
                    
                    html += `
                    </select>
                    </div>
                    <div class="input-field col s12">
                        <label for="description" style="position:static;">Description (Optional)</label>
                        <textarea class="materialize-textarea" placeholder="eg. Located on right of south entrance" name="description" id="description" rows="4" cols="12"></textarea>
                    </div>
                    <input type="hidden" name="x" id="x" value="${e.latlng.lat}">
                    <input type="hidden" name="y" id="y" value="${e.latlng.lng}">
                    <div class="input-field col s12">
                      <button class="waves-effect waves-light btn" type="submit">Add Marker</button>  
                    </div>
                    
                </div>
            </form>
        </div>
    </div>`;
                pane.innerHTML = html;
                pane.style.left = '10px';

                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);
                } else {
                    closeContainer();
                }
            } else if(mode === 'update'){
                let x = document.querySelector('#x')
                let y = document.querySelector('#y')
                if(x != null && y != null){
                    x.value = e.latlng.lat;
                    y.value = e.latlng.lng;
                    currentMarker.setLatLng(e.latlng);
                }
            }  
        }
    
        function changeMode(){
            if(mode === 'view'){
                mode = 'edit';
                alert('Mode changed to EDIT');
            } else {
                mode = 'view';
                alert('Mode changed to VIEW');
            }
        }

        function recenterMap() {
            map.setView([10.646447, -61.400807], 13);
        }
        
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            minZoom: 16,
            maxZoom: 50,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Prevent scrolling
        document.body.style.overflow = 'hidden';
    </script>
{% endblock %}